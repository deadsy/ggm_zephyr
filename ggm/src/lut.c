/*
 * Copyright (c) 2019 Jason T. Harris. (sirmanlypowers@gmail.com)
 *
 * SPDX-License-Identifier: Apache-2.0
 */

#include <inttypes.h>

#include "const.h"

/******************************************************************************
 * LUT based cosine function - generated by ./tools/lut.py
 */

#define COS_LUT_BITS (7U)
#define COS_LUT_SIZE (1U << COS_LUT_BITS)

static const float COS_LUT_data[COS_LUT_SIZE << 1] = {
	1.000000e+00, -1.204544e-03, 9.987955e-01, -3.610730e-03, 9.951847e-01, -6.008217e-03, 9.891765e-01, -8.391230e-03,
	9.807853e-01, -1.075403e-02, 9.700313e-01, -1.309092e-02, 9.569403e-01, -1.539627e-02, 9.415441e-01, -1.766453e-02,
	9.238795e-01, -1.989024e-02, 9.039893e-01, -2.206803e-02, 8.819213e-01, -2.419265e-02, 8.577286e-01, -2.625900e-02,
	8.314696e-01, -2.826208e-02, 8.032075e-01, -3.019708e-02, 7.730105e-01, -3.205933e-02, 7.409511e-01, -3.384434e-02,
	7.071068e-01, -3.554783e-02, 6.715590e-01, -3.716567e-02, 6.343933e-01, -3.869398e-02, 5.956993e-01, -4.012907e-02,
	5.555702e-01, -4.146749e-02, 5.141027e-01, -4.270601e-02, 4.713967e-01, -4.384164e-02, 4.275551e-01, -4.487166e-02,
	3.826834e-01, -4.579358e-02, 3.368899e-01, -4.660518e-02, 2.902847e-01, -4.730450e-02, 2.429802e-01, -4.788986e-02,
	1.950903e-01, -4.835985e-02, 1.467305e-01, -4.871333e-02, 9.801714e-02, -4.894947e-02, 4.906767e-02, -4.906767e-02,
	6.123234e-17, -4.906767e-02, -4.906767e-02, -4.894947e-02, -9.801714e-02, -4.871333e-02, -1.467305e-01, -4.835985e-02,
	-1.950903e-01, -4.788986e-02, -2.429802e-01, -4.730450e-02, -2.902847e-01, -4.660518e-02, -3.368899e-01, -4.579358e-02,
	-3.826834e-01, -4.487166e-02, -4.275551e-01, -4.384164e-02, -4.713967e-01, -4.270601e-02, -5.141027e-01, -4.146749e-02,
	-5.555702e-01, -4.012907e-02, -5.956993e-01, -3.869398e-02, -6.343933e-01, -3.716567e-02, -6.715590e-01, -3.554783e-02,
	-7.071068e-01, -3.384434e-02, -7.409511e-01, -3.205933e-02, -7.730105e-01, -3.019708e-02, -8.032075e-01, -2.826208e-02,
	-8.314696e-01, -2.625900e-02, -8.577286e-01, -2.419265e-02, -8.819213e-01, -2.206803e-02, -9.039893e-01, -1.989024e-02,
	-9.238795e-01, -1.766453e-02, -9.415441e-01, -1.539627e-02, -9.569403e-01, -1.309092e-02, -9.700313e-01, -1.075403e-02,
	-9.807853e-01, -8.391230e-03, -9.891765e-01, -6.008217e-03, -9.951847e-01, -3.610730e-03, -9.987955e-01, -1.204544e-03,
	-1.000000e+00, 1.204544e-03, -9.987955e-01, 3.610730e-03, -9.951847e-01, 6.008217e-03, -9.891765e-01, 8.391230e-03,
	-9.807853e-01, 1.075403e-02, -9.700313e-01, 1.309092e-02, -9.569403e-01, 1.539627e-02, -9.415441e-01, 1.766453e-02,
	-9.238795e-01, 1.989024e-02, -9.039893e-01, 2.206803e-02, -8.819213e-01, 2.419265e-02, -8.577286e-01, 2.625900e-02,
	-8.314696e-01, 2.826208e-02, -8.032075e-01, 3.019708e-02, -7.730105e-01, 3.205933e-02, -7.409511e-01, 3.384434e-02,
	-7.071068e-01, 3.554783e-02, -6.715590e-01, 3.716567e-02, -6.343933e-01, 3.869398e-02, -5.956993e-01, 4.012907e-02,
	-5.555702e-01, 4.146749e-02, -5.141027e-01, 4.270601e-02, -4.713967e-01, 4.384164e-02, -4.275551e-01, 4.487166e-02,
	-3.826834e-01, 4.579358e-02, -3.368899e-01, 4.660518e-02, -2.902847e-01, 4.730450e-02, -2.429802e-01, 4.788986e-02,
	-1.950903e-01, 4.835985e-02, -1.467305e-01, 4.871333e-02, -9.801714e-02, 4.894947e-02, -4.906767e-02, 4.906767e-02,
	-1.836970e-16, 4.906767e-02, 4.906767e-02, 4.894947e-02, 9.801714e-02, 4.871333e-02, 1.467305e-01, 4.835985e-02,
	1.950903e-01, 4.788986e-02, 2.429802e-01, 4.730450e-02, 2.902847e-01, 4.660518e-02, 3.368899e-01, 4.579358e-02,
	3.826834e-01, 4.487166e-02, 4.275551e-01, 4.384164e-02, 4.713967e-01, 4.270601e-02, 5.141027e-01, 4.146749e-02,
	5.555702e-01, 4.012907e-02, 5.956993e-01, 3.869398e-02, 6.343933e-01, 3.716567e-02, 6.715590e-01, 3.554783e-02,
	7.071068e-01, 3.384434e-02, 7.409511e-01, 3.205933e-02, 7.730105e-01, 3.019708e-02, 8.032075e-01, 2.826208e-02,
	8.314696e-01, 2.625900e-02, 8.577286e-01, 2.419265e-02, 8.819213e-01, 2.206803e-02, 9.039893e-01, 1.989024e-02,
	9.238795e-01, 1.766453e-02, 9.415441e-01, 1.539627e-02, 9.569403e-01, 1.309092e-02, 9.700313e-01, 1.075403e-02,
	9.807853e-01, 8.391230e-03, 9.891765e-01, 6.008217e-03, 9.951847e-01, 3.610730e-03, 9.987955e-01, 1.204544e-03,
};

#define FRAC_BITS (32U - COS_LUT_BITS)
#define FRAC_MASK ((1U << FRAC_BITS) - 1)
#define FRAC_SCALE (1.f / (float)FRAC_MASK)

float cos_lookup(uint32_t x)
{
	uint32_t idx = (x >> FRAC_BITS) << 1;
	float frac = (x & FRAC_MASK) * FRAC_SCALE;
	float y = COS_LUT_data[idx];
	float dy = COS_LUT_data[idx + 1];

	return y + (dy * frac);
}

/******************************************************************************
 * LUT based equivalents to cosf/sinf
 */

static float abs_eval(float x)
{
	if (x < 0.f) {
		return -x;
	}
	return x;
}

float cos_eval(float x)
{
	uint32_t xi = (uint32_t) (abs_eval(x) * PhaseScale);

	return cos_lookup(xi);
}

float sin_eval(float x)
{
	uint32_t xi = QuarterCycle - (uint32_t) (abs_eval(x) * PhaseScale);

	return cos_lookup(xi);
}

float tan_eval(float x)
{
	return sin_eval(x) / cos_eval(x);
}
